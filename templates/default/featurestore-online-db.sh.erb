#!/usr/bin/env bash

#
# This script is used to create/remove a MySQL Cluster database for each online featurestore
#

help() {
    echo ""
    echo "usage: $0 [add|rm] databasename db_username [db_password db_password_encrypted]"
    echo ""
    exit 1
}

random-string()
{
    cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w ${1:-16} | head -n 1
}


MYSQL_CMD="sudo <%= node['ndb']['dir'] %>/mysql-cluster/ndb/scripts/mysql-client.sh -e"


if [ $# -lt 3 ]; then
    help
fi

# Check mysql database name is valid syntactically
# https://stackoverflow.com/questions/9537771/mysql-database-name-restrictions
DB_NAME=$2
# if [ "$DB_NAME" =~ "^[^\\/?%*:|\"<>.]{1,64}$" ]; then
if [ "$DB_NAME" =~ ";" ]; then
   echo "Invalid database name. The string length for the database name must be >2 and <=64. It may also contai an invalid character."
   exit 5
fi

DB_USERNAME=$3
if [ "$DB_USERNAME" =~ ";" ]; then
 echo "Invalid database username. The string length for the username must be >2 and <=64. It may also contain an invalid character."
 exit 5
fi

   
if [ "$1" == "add" ] ; then

  if [ $# -lt 3 ]; then
    help
  fi

  # generate random password
  # DB_PWD=$(random-string)
  DB_PWD=$4
  DB_PWD_ENCRYPTED=$5
  
  $MYSQL_CMD "CREATE DATABASE IF NOT EXISTS $DB_NAME"
  RES=$?
  if [ $RES -eq 0 ]; then
     $MYSQL_CMD "CREATE USER \"$DB_USERNAME\"@'%' IDENTIFIED BY \"$DB_PWD\""
     RES=$?     
     if [ $RES -eq 0 ]; then
	$MYSQL_CMD "GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO \"$DB_USERNAME\"@'%'"
        RES=$?
        if [ $RES -eq 0 ]; then
          $MYSQL_CMD "UPDATE `hopsworks`.`feature_store` SET `hopsworks`.`feature_store`.`online_db_password` = \"$DB_PWD_ENCRYPTED\" WHERE `hopsworks`.`feature_store`.`project_id` = (SELECT `hopsworks`.`project`.`id` FROM `hopsworks`.`project` WHERE `hopsworks`.`project`.`projectname`=\"$DB_NAME\")"
          RES=$?
        fi
     fi
  fi
  exit $RES
  
elif [ "$1" == "rm" ] ; then

  $MYSQL_CMD "DROP DATABASE IF EXISTS $DB_NAME"
  if [ $? -ne 0 ]; then
     echo "Problem when trying to drop the database $DB_NAME"
  fi
  $MYSQL_CMD "DROP USER IF EXISTS \"$DB_USERNAME\"@'%'"
  if [ $? -ne 0 ]; then
     echo "Problem when trying to drop the user $DB_USERNAME"
  fi
else
 help
fi 
